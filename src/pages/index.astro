---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

// Fetch local posts
const localPosts = await getCollection('blog', ({ data }) => !data.draft);

// Fetch dev.to posts
let devtoPosts: any[] = [];
try {
  const response = await fetch('https://dev.to/api/articles?username=mike-vincent');
  if (response.ok) {
    devtoPosts = await response.json();
  }
} catch (e) {
  console.error('Failed to fetch dev.to posts:', e);
}

// Map local posts to unified structure
const mappedLocalPosts = localPosts.map(post => ({
  id: post.id,
  title: post.data.title,
  subtitle: post.data.subtitle,
  date: post.data.date,
  tags: post.data.tags,
  image: post.data.image,
  body: post.body,
  isExternal: false,
  url: `/blog/${post.id}/`,
}));

// Map dev.to posts to unified structure
const mappedDevtoPosts = devtoPosts.map(article => ({
  id: `devto-${article.id}`,
  title: article.title,
  subtitle: article.description,
  date: new Date(article.published_at),
  tags: article.tag_list || [],
  image: article.cover_image,
  body: '',
  isExternal: true,
  url: article.url,
}));

// Combine and sort by date (newest first)
const sortedPosts = [...mappedLocalPosts, ...mappedDevtoPosts].sort((a, b) => b.date.valueOf() - a.date.valueOf());
---

<Base title="Mike Vincent">
  <div class="section-content">
    <div class="row">
      <div class="column large-centered large-10 small-12">
        <div class="posts-grid">
          {sortedPosts.map((post, index) => {
            const minsAgo = Math.floor((Date.now() - post.date.getTime()) / (1000 * 60));
            const hoursAgo = Math.floor(minsAgo / 60);
            const daysAgo = Math.floor(hoursAgo / 24);
            const weeksAgo = Math.floor(daysAgo / 7);
            const monthsAgo = Math.floor(daysAgo / 30);
            const yearsAgo = Math.floor(daysAgo / 365);
            const relativeTime = daysAgo === 0 ? 'Today' : daysAgo === 1 ? '1 day ago' : `${daysAgo} days ago`;
            const compactTime = yearsAgo >= 1 ? `${yearsAgo}y` : monthsAgo >= 1 ? `${monthsAgo}mo` : weeksAgo >= 1 ? `${weeksAgo}w` : daysAgo >= 1 ? `${daysAgo}d` : hoursAgo >= 1 ? `${hoursAgo}h` : `${minsAgo}m`;
            const linkProps = post.isExternal ? { target: '_blank', rel: 'noopener noreferrer' } : {};
            return (
              <div class="post-card" data-index={index} style={index >= 10 ? 'display:none' : ''}>
                <div class="post-card-content">
                  <div class="post-header">
                    <img src="/assets/images/headshot.jpg" alt="Mike Vincent" class="post-avatar" transition:name={`avatar-${post.id}`} />
                    <div class="post-header-text">
                      <div class="title-row">
                        <h2><a href={post.url} {...linkProps} transition:name={`title-${post.id}`}>{post.title}</a> <span class="post-age">· {compactTime}</span></h2>
                        <div class="post-menu-wrapper">
                          <button class="post-menu" aria-label="More options" onclick="this.parentElement.classList.toggle('open')"><span class="material-symbols-outlined">more_vert</span></button>
                          <div class="post-menu-dropdown">
                            <a href={post.url} {...linkProps} class="menu-item"><span class="material-symbols-outlined">open_in_new</span>Open</a>
                            <button class="menu-item" onclick={`navigator.clipboard.writeText('${post.url}'); this.querySelector('span:last-child').textContent='Copied!'; setTimeout(() => this.querySelector('span:last-child').textContent='Copy link', 1500)`}><span class="material-symbols-outlined">link</span><span>Copy link</span></button>
                            <button class="menu-item" onclick={`navigator.clipboard.writeText('[${post.title.replace(/'/g, "\\'")}](${post.url})'); this.querySelector('span:last-child').textContent='Copied!'; setTimeout(() => this.querySelector('span:last-child').textContent='Copy markdown', 1500)`}><span class="material-symbols-outlined">content_copy</span><span>Copy markdown</span></button>
                            <button class="menu-item" onclick={`navigator.share?.({url: '${post.url}', title: '${post.title.replace(/'/g, "\\'")}'});`}><span class="material-symbols-outlined">share</span><span>Share</span></button>
                          </div>
                        </div>
                      </div>
                      <p class="subtitle">{post.subtitle}</p>
                    </div>
                  </div>
                  {post.body && (
                    <div class="body">
                      <p>{post.body}</p>
                    </div>
                  )}
                  {post.image && (
                    <div class="post-card-thumb">
                      <img src={post.image} alt="" />
                      <div class="thumb-overlay">
                        <span class="thumb-title">{post.title}</span>
                        <span class="thumb-subtitle">{post.subtitle}</span>
                        <span class="thumb-meta">By Mike Vincent · {relativeTime}</span>
                      </div>
                    </div>
                  )}
                  <ul class="post-tags">
                    {post.tags.map(tag => (
                      <li><a href={`/tags/#${tag}`}>#{tag}</a></li>
                    ))}
                  </ul>
                </div>
              </div>
            );
          })}
        </div>
        {sortedPosts.length > 10 && (
          <button id="load-more" class="load-more-btn">Show more</button>
        )}
      </div>
    </div>
  </div>

  {/* Prefetch next 5 posts */}
  {sortedPosts.slice(10, 15).map(post => (
    !post.isExternal && <link rel="prefetch" href={post.url} />
  ))}
</Base>

<script is:inline>
  document.addEventListener('astro:page-load', () => {
    const btn = document.getElementById('load-more');
    if (!btn) return;

    let shown = 10;
    const posts = document.querySelectorAll('.post-card[data-index]');
    const total = posts.length;

    if (shown >= total) btn.style.display = 'none';

    btn.addEventListener('click', () => {
      const nextBatch = Math.min(shown + 10, total);
      posts.forEach((post, i) => {
        if (i < nextBatch) post.style.display = '';
      });
      shown = nextBatch;
      if (shown >= total) btn.style.display = 'none';
    });
  });
</script>

<style>
  .load-more-btn {
    display: block;
    margin: 24px auto;
    padding: 12px 32px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    min-height: 44px;
  }
  :global(.theme-dark) .load-more-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
  }
  :global(.theme-light) .load-more-btn {
    background: rgba(0, 0, 0, 0.05);
    color: #000;
  }
  .load-more-btn:hover {
    opacity: 0.8;
  }
</style>
