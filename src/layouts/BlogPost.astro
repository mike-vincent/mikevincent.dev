---
import Base from './Base.astro';
import ShareLinks from '../components/ShareLinks.astro';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  subtitle: string;
  date: Date;
  tags: string[];
  image?: string;
  slug: string;
}

const { title, subtitle, date, tags, image, slug } = Astro.props;

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const currentIndex = sortedPosts.findIndex(post => post.id === slug);
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
const isoDate = date.toISOString().split('T')[0];
const url = `https://mikevincent.dev/blog/${slug}/`;
---

<Base title={`${title} - Mike Vincent`} description={subtitle}>
  <article class="section">
    <div class="section-content">
      <div class="row">
        <div class="column large-centered large-10 small-12">
          <div class="post-content">
            <div class="post-header">
              <img src="/assets/images/headshot.jpg" alt="Mike Vincent" class="post-avatar">
              <div class="post-header-text">
                <div class="title-row">
                  <h1>{title}</h1>
                  <button class="post-menu" aria-label="More options">&#8942;</button>
                </div>
                <p class="subtitle">{subtitle}</p>
              </div>
            </div>

            {image && <img src={image} alt="" class="post-image" />}

            <div class="body">
              <p><time class="dateline" datetime={isoDate}>{dateStr}</time> â€” <slot /></p>
            </div>

            <ul class="post-tags">
              {tags.map(tag => (
                <li><a href={`/tags/#${tag}`}>#{tag}</a></li>
              ))}
            </ul>
          </div>

          <ShareLinks title={title} url={url} />

          <div class="post-nav">
            {prevPost && (
              <a href={`/blog/${prevPost.id}/`} class="post-nav-item prev">
                <svg class="nav-chevron" viewBox="0 0 24 24">
                  <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="nav-text">
                  <span class="nav-label">Previous Post</span>
                  <span class="nav-title">{prevPost.data.title}</span>
                </div>
              </a>
            )}
            {nextPost && (
              <a href={`/blog/${nextPost.id}/`} class="post-nav-item next">
                <svg class="nav-chevron" viewBox="0 0 24 24">
                  <path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="nav-text">
                  <span class="nav-label">Next Post</span>
                  <span class="nav-title">{nextPost.data.title}</span>
                </div>
              </a>
            )}
          </div>
        </div>
      </div>
    </div>
  </article>
</Base>

<style>
  .post-content h1 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 4px;
    color: #007AFF;
  }
</style>
