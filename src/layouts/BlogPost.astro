---
import Base from './Base.astro';
import ShareLinks from '../components/ShareLinks.astro';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  subtitle: string;
  date: Date;
  tags: string[];
  image?: string;
  slug: string;
}

const { title, subtitle, date, tags, image, slug } = Astro.props;

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const currentIndex = sortedPosts.findIndex(post => post.id === slug);
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

const url = `https://mikevincent.dev/blog/${slug}/`;
const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
---

<Base title={`${title} - Mike Vincent`} description={subtitle} image={image}>
  <div class="section-content">
    <div class="row">
      <div class="column large-centered large-10 small-12">
        <div class="post-content">
            <div class="post-header">
              <div class="post-header-text">
                <div class="title-row">
                  <h1 transition:name={`title-${slug}`}>{title}</h1>
                  <button class="post-menu" aria-label="More options"><span class="material-symbols-outlined">more_vert</span></button>
                </div>
                <p class="subtitle">{subtitle}</p>
                <p class="post-date">{dateStr}</p>
              </div>
            </div>

            {image && <img src={image} alt="" class="post-image" transition:name={`image-${slug}`} />}

            <div class="body">
              <slot />
            </div>

            <ul class="post-tags">
              {tags.map(tag => (
                <li><a href={`/tags/#${tag}`}>#{tag}</a></li>
              ))}
            </ul>
          </div>

          <ShareLinks title={title} url={url} />

          <div class="post-nav">
            {prevPost && (
              <a href={`/blog/${prevPost.id}/`} class="post-nav-item prev">
                <svg class="nav-chevron" viewBox="0 0 24 24">
                  <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="nav-text">
                  <span class="nav-label">Previous Post</span>
                  <span class="nav-title">{prevPost.data.title}</span>
                </div>
              </a>
            )}
            {nextPost && (
              <a href={`/blog/${nextPost.id}/`} class="post-nav-item next">
                <svg class="nav-chevron" viewBox="0 0 24 24">
                  <path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="nav-text">
                  <span class="nav-label">Next Post</span>
                  <span class="nav-title">{nextPost.data.title}</span>
                </div>
              </a>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</Base>

<style>
  .post-content h1 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 4px;
  }
  :global(.theme-dark) .post-content h1 { color: #fff; }
  :global(.theme-light) .post-content h1 { color: #000; }

  .post-date {
    font-size: 14px;
    margin: 8px 0 0;
  }
  :global(.theme-dark) .post-date { color: rgba(255, 255, 255, 0.6); }
  :global(.theme-light) .post-date { color: rgba(0, 0, 0, 0.6); }

  .post-content .body > :first-child {
    display: inline;
  }
</style>
